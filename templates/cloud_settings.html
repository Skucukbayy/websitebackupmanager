{% extends "base.html" %}

{% block title %}{{ t('cloud_settings') }} - {{ t('app_name') }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="breadcrumb">
        <a href="/">{{ t('dashboard') }}</a>
        <span>/</span>
        <a href="/admin">{{ t('admin_panel') }}</a>
        <span>/</span>
        <span>{{ t('cloud_settings') }}</span>
    </div>
</div>

<div class="cloud-settings-grid">
    <!-- Google Drive -->
    <div class="card cloud-card" id="card-google_drive">
        <div class="card-header">
            <div class="cloud-provider-info">
                <div class="cloud-icon google-drive-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32">
                        <path d="M4.433 22l-1.6-2.77L9.07 8.192l1.6 2.77z" fill="#0066DA" />
                        <path d="M20.16 22H4.433l1.6-2.77h15.727z" fill="#00AC47" />
                        <path d="M22.357 18.77L14.93 5.462h-3.2L18.56 18.77z" fill="#EA4335" />
                        <path d="M9.07 8.192L5.84 2h3.2l6.66 11.538z" fill="#00832D" />
                        <path d="M14.93 5.462l3.63 6.307-1.6 2.77-5.26-9.077z" fill="#2684FC" />
                        <path d="M8.233 19.23l1.6-2.77 5.26 2.77h-6.86z" fill="#FFBA00" />
                    </svg>
                </div>
                <div>
                    <h3>Google Drive</h3>
                    <span class="cloud-status" id="status-google_drive">
                        {% if credentials.google_drive.is_connected %}
                        <span class="badge badge-success">{{ t('connected') }}</span>
                        {% elif credentials.google_drive.has_client_id %}
                        <span class="badge badge-warning">{{ t('not_connected') }}</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ t('not_configured') }}</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>Client ID</label>
                <input type="text" id="google_drive_client_id" class="form-control"
                    placeholder="xxxxxx.apps.googleusercontent.com"
                    value="{{ '••••••••' if credentials.google_drive.has_client_id else '' }}">
            </div>
            <div class="form-group">
                <label>Client Secret</label>
                <input type="password" id="google_drive_client_secret" class="form-control"
                    placeholder="GOCSPX-xxxxxxxxx"
                    value="{{ '••••••••' if credentials.google_drive.has_client_secret else '' }}">
            </div>
            <div class="cloud-actions">
                <button class="btn btn-primary btn-sm" onclick="saveCredentials('google_drive')">
                    {{ t('save') }}
                </button>
                {% if credentials.google_drive.has_client_id and not credentials.google_drive.is_connected %}
                <button class="btn btn-success btn-sm" onclick="connectCloud('google_drive')">
                    {{ t('connect') }}
                </button>
                {% endif %}
                {% if credentials.google_drive.is_connected %}
                <button class="btn btn-danger btn-sm" onclick="disconnectCloud('google_drive')">
                    {{ t('disconnect') }}
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- OneDrive -->
    <div class="card cloud-card" id="card-onedrive">
        <div class="card-header">
            <div class="cloud-provider-info">
                <div class="cloud-icon onedrive-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32">
                        <path
                            d="M14.31 6c-1.86 0-3.52.96-4.47 2.43A4.47 4.47 0 007.5 7.5C5.01 7.5 3 9.51 3 12s2.01 4.5 4.5 4.5h9c2.49 0 4.5-2.01 4.5-4.5 0-2.35-1.81-4.28-4.11-4.47A4.98 4.98 0 0014.31 6z"
                            fill="#0078D4" />
                    </svg>
                </div>
                <div>
                    <h3>OneDrive</h3>
                    <span class="cloud-status" id="status-onedrive">
                        {% if credentials.onedrive.is_connected %}
                        <span class="badge badge-success">{{ t('connected') }}</span>
                        {% elif credentials.onedrive.has_client_id %}
                        <span class="badge badge-warning">{{ t('not_connected') }}</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ t('not_configured') }}</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>Client ID (Application ID)</label>
                <input type="text" id="onedrive_client_id" class="form-control"
                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                    value="{{ '••••••••' if credentials.onedrive.has_client_id else '' }}">
            </div>
            <div class="form-group">
                <label>Client Secret</label>
                <input type="password" id="onedrive_client_secret" class="form-control" placeholder="xxxxxxxxxxxxxxxxx"
                    value="{{ '••••••••' if credentials.onedrive.has_client_secret else '' }}">
            </div>
            <div class="cloud-actions">
                <button class="btn btn-primary btn-sm" onclick="saveCredentials('onedrive')">
                    {{ t('save') }}
                </button>
                {% if credentials.onedrive.has_client_id and not credentials.onedrive.is_connected %}
                <button class="btn btn-success btn-sm" onclick="connectCloud('onedrive')">
                    {{ t('connect') }}
                </button>
                {% endif %}
                {% if credentials.onedrive.is_connected %}
                <button class="btn btn-danger btn-sm" onclick="disconnectCloud('onedrive')">
                    {{ t('disconnect') }}
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Dropbox -->
    <div class="card cloud-card" id="card-dropbox">
        <div class="card-header">
            <div class="cloud-provider-info">
                <div class="cloud-icon dropbox-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32">
                        <path d="M12 6.8L6 10.7l6 3.9-6 3.9L0 14.6l6-3.9L0 6.8 6 2.9z" fill="#0061FF" />
                        <path d="M12 6.8l6 3.9-6 3.9 6 3.9 6-3.9-6-3.9 6-3.9L18 2.9z" fill="#0061FF" />
                        <path d="M6 19.4l6-3.9 6 3.9-6 3.9z" fill="#0061FF" />
                    </svg>
                </div>
                <div>
                    <h3>Dropbox</h3>
                    <span class="cloud-status" id="status-dropbox">
                        {% if credentials.dropbox.is_connected %}
                        <span class="badge badge-success">{{ t('connected') }}</span>
                        {% elif credentials.dropbox.has_client_id %}
                        <span class="badge badge-warning">{{ t('not_connected') }}</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ t('not_configured') }}</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>App Key</label>
                <input type="text" id="dropbox_client_id" class="form-control" placeholder="xxxxxxxxxxxxxxx"
                    value="{{ '••••••••' if credentials.dropbox.has_client_id else '' }}">
            </div>
            <div class="form-group">
                <label>App Secret</label>
                <input type="password" id="dropbox_client_secret" class="form-control" placeholder="xxxxxxxxxxxxxxx"
                    value="{{ '••••••••' if credentials.dropbox.has_client_secret else '' }}">
            </div>
            <div class="cloud-actions">
                <button class="btn btn-primary btn-sm" onclick="saveCredentials('dropbox')">
                    {{ t('save') }}
                </button>
                {% if credentials.dropbox.has_client_id and not credentials.dropbox.is_connected %}
                <button class="btn btn-success btn-sm" onclick="connectCloud('dropbox')">
                    {{ t('connect') }}
                </button>
                {% endif %}
                {% if credentials.dropbox.is_connected %}
                <button class="btn btn-danger btn-sm" onclick="disconnectCloud('dropbox')">
                    {{ t('disconnect') }}
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .cloud-settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
        gap: 24px;
        margin-top: 16px;
    }

    .cloud-card {
        border-radius: 16px;
        overflow: hidden;
    }

    .cloud-card .card-header {
        padding: 20px 24px;
    }

    .cloud-provider-info {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .cloud-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
    }

    .cloud-card .card-body {
        padding: 0 24px 24px;
    }

    .cloud-card .form-group {
        margin-bottom: 12px;
    }

    .cloud-card .form-group label {
        display: block;
        margin-bottom: 4px;
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .cloud-card .form-control {
        width: 100%;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        font-size: 0.9rem;
    }

    .cloud-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
        flex-wrap: wrap;
    }

    .btn-sm {
        padding: 6px 16px;
        font-size: 0.85rem;
    }

    .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-success {
        background: rgba(0, 200, 83, 0.2);
        color: #00c853;
    }

    .badge-warning {
        background: rgba(255, 171, 0, 0.2);
        color: #ffab00;
    }

    .badge-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.5);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    async function saveCredentials(provider) {
        const clientId = document.getElementById(`${provider}_client_id`).value;
        const clientSecret = document.getElementById(`${provider}_client_secret`).value;

        if (!clientId || clientId === '••••••••') {
            if (!clientSecret || clientSecret === '••••••••') {
                showToast(t('fill_credentials'), 'warning');
                return;
            }
        }

        try {
            const body = { provider };
            if (clientId && clientId !== '••••••••') body.client_id = clientId;
            if (clientSecret && clientSecret !== '••••••••') body.client_secret = clientSecret;

            const resp = await fetch('/api/admin/cloud/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const data = await resp.json();
            if (data.success) {
                showToast(t('credentials_saved'), 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || t('operation_failed'), 'error');
            }
        } catch (e) {
            showToast(t('operation_failed'), 'error');
        }
    }

    async function connectCloud(provider) {
        try {
            const resp = await fetch(`/api/cloud/${provider}/auth`);
            const data = await resp.json();

            if (data.auth_url) {
                window.open(data.auth_url, '_blank', 'width=600,height=700');
            } else {
                showToast(data.error || t('operation_failed'), 'error');
            }
        } catch (e) {
            showToast(t('operation_failed'), 'error');
        }
    }

    async function disconnectCloud(provider) {
        if (!confirm(t('confirm_disconnect'))) return;

        try {
            const resp = await fetch(`/api/cloud/${provider}/disconnect`, {
                method: 'POST'
            });
            const data = await resp.json();

            if (data.success) {
                showToast(t('disconnected'), 'success');
                setTimeout(() => location.reload(), 1000);
            }
        } catch (e) {
            showToast(t('operation_failed'), 'error');
        }
    }
</script>
{% endblock %}